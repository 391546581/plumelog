{
  "filename": "ng.md",
  "__html": "<h2 id=\"nginx%E6%97%A5%E5%BF%97%E6%90%9C%E9%9B%86\">nginx日志搜集 <a class=\"header-anchor\" href=\"#nginx%E6%97%A5%E5%BF%97%E6%90%9C%E9%9B%86\">#</a></h2>\n<h3 id=\"%E4%B8%80%E3%80%81%E9%85%8D%E7%BD%AEnginx\">一、配置nginx <a class=\"header-anchor\" href=\"#%E4%B8%80%E3%80%81%E9%85%8D%E7%BD%AEnginx\">#</a></h3>\n<ul>\n<li>复制nginx.conf里面的配置到自己的nginx配置之下，在http{}中添加下面配置</li>\n</ul>\n<pre><code>       log_format json '{&quot;dtTime&quot;:&quot;$time_iso8601&quot;,'\n                   '&quot;logLevel&quot;:&quot;INFO&quot;,'\n                   '&quot;className&quot;:&quot;$uri&quot;,'\n                   '&quot;content&quot;:&quot;requestParam=&gt;$query_string \\n status=&gt;$status \\n size=&gt;$body_bytes_sent \\n request_time=&gt;$request_time&quot;,'\n                   '&quot;serverName&quot;:&quot;$server_addr&quot;,'\n                   '&quot;traceId&quot;:&quot;$remote_addr&quot;,'\n                   '&quot;method&quot;:&quot;$http_user_agent&quot;,'\n                   '&quot;appName&quot;:&quot;nginx&quot;'\n                   '}';\n       access_log  /var/log/nginx/access.log  json;\n</code></pre>\n<ul>\n<li>nginx -t 后 nginx  -s reload</li>\n</ul>\n<h3 id=\"%E4%BA%8C%E3%80%81%E4%B8%8B%E8%BD%BD%E5%B9%B6%E9%85%8D%E7%BD%AElogstash\">二、下载并配置logstash <a class=\"header-anchor\" href=\"#%E4%BA%8C%E3%80%81%E4%B8%8B%E8%BD%BD%E5%B9%B6%E9%85%8D%E7%BD%AElogstash\">#</a></h3>\n<ul>\n<li>下载logstash并安装</li>\n</ul>\n<p>1、下载logstash-6.6.0安装包，下载路径：logstash-6.6.0，然后解压之es的同级目录（方便管理）；或直接在服务器上下载：</p>\n<pre><code>    wget https://artifacts.elastic.co/downloads/logstash/logstash-6.6.0.tar.gz\n</code></pre>\n<p>2、将安装包上次到服务器，然后解压安装包，例如解压到：/usr/local/</p>\n<pre><code>    tar –zxvf logstash-6.6.0.tar.gz\n</code></pre>\n<p>3、重命名安装目录</p>\n<pre><code>    mv logstash-6.6.0 logstash\n</code></pre>\n<ul>\n<li>配置logstash</li>\n</ul>\n<p>1.进入logstash 安装目录</p>\n<pre><code>     mkdir nginx-log\n     cd nginx-log\n     vim logstash.conf\n</code></pre>\n<ul>\n<li>配置内容</li>\n</ul>\n<pre><code>     input {\n        file {\n                path =&gt; &quot;/var/log/nginx/access.log&quot; #这边和上面nginx的日志输出地址一致\n                type =&gt; &quot;nginx_log&quot;\n                start_position =&gt; &quot;beginning&quot;\n                stat_interval =&gt; &quot;2&quot;\n        }\n     filter {\n         json {\n               source=&gt; &quot;message&quot;\n           }\n         date {\n               match =&gt; [&quot;dtTime&quot;, &quot;ISO8601&quot;]\n              }\n         ruby{\n               code =&gt; &quot;event.set('dtTime',(event.get('@timestamp').to_f.round(3)*1000).to_i)&quot;\n             }\n         mutate {\n               remove_field =&gt; [&quot;message&quot;]\n             }\n       }\n      output {\n         if[type] ==&quot;nginx_log&quot;{\n                redis {\n                        data_type =&gt; &quot;list&quot; #这个不用改\n                        host =&gt; &quot;10.100.2.54&quot; #plumelog的queue.redis地址\n                        db =&gt; &quot;0&quot; #plumelog的queue.redis DB\n                        port =&gt; &quot;6379&quot; #plumelog.queue.redis的端口\n                        password =&gt; &quot;plumelogredis&quot; #plumelog.queue.redis的密码\n                        key =&gt; &quot;plume_log_list&quot; #这个不用改\n                }\n        }\n      }\n</code></pre>\n<p>复制logstash.conf内容进去，并保存；可以直接把logstash.conf放到这个目录下</p>\n<p>2.启动logstash</p>\n<p>进入logstash/bin目录，用下面命令启动</p>\n<pre><code>    ./logstash -f ../nginx-log/logstash.conf\n</code></pre>\n",
  "link": "/zh-cn/docs/logstash/ng.html",
  "meta": {}
}